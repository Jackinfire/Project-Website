<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Viewer (Python Powered)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root { --font-sans: 'Inter', sans-serif; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-full text-gray-800">
    <div id="app" class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex items-center justify-between">
                    <h1 class="text-2xl font-bold text-gray-900">Project Dashboard</h1>
                </div>
                 <!-- Search and Filter Controls -->
                <div class="mt-4 flex flex-col sm:flex-row sm:items-center sm:space-x-4 space-y-4 sm:space-y-0">
                    <div class="flex-grow">
                        <label for="searchInput" class="sr-only">Search</label>
                        <input type="text" id="searchInput" placeholder="Search by keyword, title, theme..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="flex-shrink-0">
                        <button id="viewToggle" class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">
                            View Saved (<span id="savedCount">0</span>)
                        </button>
                    </div>
                </div>
                <!-- Status Text Area -->
                <div id="status-text-container" class="mt-3 text-sm text-center h-5">
                    <!-- Status text will be injected here -->
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
            <!-- Project List -->
            <div id="project-list-container" class="w-full md:w-1/3 lg:w-1/4 h-1/2 md:h-full overflow-y-auto bg-white border-r border-gray-200 scrollbar-hide">
                <div id="project-list" class="divide-y divide-gray-200">
                    <div class="p-4 text-center text-gray-500">Loading projects...</div>
                </div>
            </div>

            <!-- Project Details -->
            <div id="project-details-container" class="flex-1 h-1/2 md:h-full overflow-y-auto bg-gray-50 p-4 sm:p-6 lg:p-8">
                <div id="project-details" class="h-full">
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">No project selected</h3>
                            <p class="mt-1 text-sm text-gray-500">Select a project from the list to see its details.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        /*
        INSTRUCTIONS FOR PYTHON WEB APP:
        1. Save this file as "index.html".
        2. Save the Python code into a file named "app.py".
        3. Make sure "index.html", "app.py", and "Projects.csv" are all in the SAME directory.
        4. Install required Python libraries: pip install Flask pandas
        5. Run the Python server from your terminal: python app.py
        6. Open your web browser and go to: http://127.0.0.1:5000
        */

        // --- DOM Elements ---
        const projectListEl = document.getElementById('project-list');
        const projectDetailsEl = document.getElementById('project-details');
        const searchInput = document.getElementById('searchInput');
        const viewToggleBtn = document.getElementById('viewToggle');
        const savedCountEl = document.getElementById('savedCount');
        const statusTextContainer = document.getElementById('status-text-container');

        // --- App State ---
        let projects = [];
        let savedProjectIds = new Set();
        let currentFilters = { search: '' };
        let showingSaved = false;
        let selectedProjectId = null;

        // --- Local Storage Functions ---
        function loadSavedProjectsFromStorage() {
            const saved = localStorage.getItem('savedProjectIds');
            if (saved) {
                savedProjectIds = new Set(JSON.parse(saved).map(id => parseInt(id, 10)));
            }
            savedCountEl.textContent = savedProjectIds.size;
        }

        function saveProjectsToStorage() {
            localStorage.setItem('savedProjectIds', JSON.stringify([...savedProjectIds]));
            savedCountEl.textContent = savedProjectIds.size;
        }

        // --- Data Loading ---
        async function loadProjectsFromAPI() {
            try {
                // Fetch data from the Python backend's API endpoint.
                const response = await fetch('/api/projects');
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // The Python backend now provides lowercase keys. We just need to parse the ID.
                projects = data.map(p => ({
                    ...p,
                    id: parseInt(p.id, 10)
                }));
                renderAll();
            } catch (error) {
                const errorMessage = `Failed to load projects: ${error.message}. Is the Python server (app.py) running?`;
                displayError(errorMessage);
                projectListEl.innerHTML = `<div class="p-4 text-center text-red-500 font-semibold">${errorMessage}</div>`;
            }
        }


        // --- Rendering Functions ---
        function renderProjectList() {
            let projectsToRender = projects;

            if (showingSaved) {
                projectsToRender = projectsToRender.filter(p => savedProjectIds.has(p.id));
            }

            const searchTerm = currentFilters.search.toLowerCase();
            if (searchTerm) {
                projectsToRender = projectsToRender.filter(p => {
                    // This single search checks all relevant fields
                    return (p.title && p.title.toLowerCase().includes(searchTerm)) ||
                           (p.keywords && p.keywords.toLowerCase().includes(searchTerm)) ||
                           (p.description && p.description.toLowerCase().includes(searchTerm)) ||
                           (p.supervisor && p.supervisor.toLowerCase().includes(searchTerm)) ||
                           (p.theme && p.theme.toLowerCase().includes(searchTerm)) ||
                           (p.type && p.type.toLowerCase().includes(searchTerm));
                });
            }


            projectListEl.innerHTML = ''; // Clear list
            if (projectsToRender.length === 0) {
                 projectListEl.innerHTML = `<div class="p-4 text-center text-gray-500">No projects match your criteria.</div>`;
                 return;
            }

            projectsToRender.forEach(project => {
                const isSaved = savedProjectIds.has(project.id);
                const isSelected = project.id === selectedProjectId;
                const item = document.createElement('div');
                item.className = `p-4 cursor-pointer hover:bg-indigo-50 transition-colors duration-150 ${isSelected ? 'bg-indigo-100' : 'bg-white'}`;
                item.dataset.id = project.id;
                item.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-gray-800 truncate">${project.title || 'No Title'}</p>
                            <p class="text-sm text-gray-600">${project.supervisor || 'N/A'}</p>
                        </div>
                        <button data-id="${project.id}" class="save-btn ml-4 p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-yellow-500 flex-shrink-0">
                            <i class="${isSaved ? 'fas' : 'far'} fa-star text-yellow-500"></i>
                        </button>
                    </div>
                `;
                projectListEl.appendChild(item);
            });
        }

        function renderProjectDetails(projectId) {
            selectedProjectId = projectId;
            const project = projects.find(p => p.id === projectId);
            if (!project) {
                projectDetailsEl.innerHTML = `<div>Error: Project not found.</div>`;
                return;
            }
            
            const keywordsHtml = (project.keywords || '').split(',').map(k => `<span class="bg-gray-200 text-gray-700 px-2 py-1 rounded-full text-xs">${k.trim()}</span>`).join('');

            projectDetailsEl.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg p-6 h-full flex flex-col">
                    <div class="flex-grow">
                        <div class="flex justify-between items-start mb-4">
                            <h2 class="text-2xl font-bold text-gray-900">${project.title}</h2>
                            <button data-id="${project.id}" class="save-btn-details ml-4 p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                                <i class="${savedProjectIds.has(project.id) ? 'fas' : 'far'} fa-star text-2xl text-yellow-500"></i>
                                <span class="sr-only">Save project</span>
                            </button>
                        </div>
                        <p class="text-md text-gray-600 mb-4">Supervised by <span class="font-semibold">${project.supervisor}</span></p>
                        
                        <div class="prose max-w-none text-gray-700">
                            <p>${project.description}</p>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-6 border-t border-gray-200 flex-shrink-0">
                        <div class="flex flex-wrap gap-4 text-sm">
                            <div class="flex items-center">
                                <span class="font-semibold mr-2">Theme:</span>
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${project.theme}</span>
                            </div>
                            <div class="flex items-center">
                                <span class="font-semibold mr-2">Type:</span>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full">${project.type}</span>
                            </div>
                        </div>
                        <div class="mt-4">
                             <span class="font-semibold mr-2">Keywords:</span>
                             <div class="flex flex-wrap gap-2 mt-1">${keywordsHtml}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderStatusText() {
            if (showingSaved) {
                statusTextContainer.innerHTML = `<p class="text-indigo-600 font-medium">Showing only saved projects.</p>`;
            } else {
                statusTextContainer.innerHTML = '';
            }
        }
        
        function updateToggleButton() {
             if (showingSaved) {
                viewToggleBtn.textContent = 'View All Projects';
                viewToggleBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                viewToggleBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
            } else {
                viewToggleBtn.innerHTML = `View Saved (<span id="savedCount">${savedProjectIds.size}</span>)`;
                viewToggleBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                viewToggleBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
            }
        }

        // --- Event Handlers ---
        function handleSaveClick(projectId) {
            if (savedProjectIds.has(projectId)) {
                savedProjectIds.delete(projectId);
            } else {
                savedProjectIds.add(projectId);
            }
            saveProjectsToStorage();
            
            // Re-render the list and details to reflect the change
            renderProjectList();
            if (selectedProjectId === projectId) {
                renderProjectDetails(projectId);
            }
            updateToggleButton();
        }

        searchInput.addEventListener('input', (e) => {
            currentFilters.search = e.target.value;
            renderProjectList();
        });

        viewToggleBtn.addEventListener('click', () => {
            showingSaved = !showingSaved;
            updateToggleButton();
            renderProjectList();
            renderStatusText();
        });
        
        projectListEl.addEventListener('click', (e) => {
            const item = e.target.closest('[data-id]');
            if (!item) return;

            const projectId = parseInt(item.dataset.id, 10);
            if (isNaN(projectId)) return;

            if (e.target.closest('.save-btn')) {
                handleSaveClick(projectId);
            } else {
                renderProjectDetails(projectId);
                // After rendering the details, re-render the list to update the selection highlight.
                renderProjectList();
            }
        });
        
        projectDetailsEl.addEventListener('click', (e) => {
             const saveButton = e.target.closest('.save-btn-details');
             if(saveButton){
                const projectId = parseInt(saveButton.dataset.id, 10);
                if (!isNaN(projectId)) {
                    handleSaveClick(projectId);
                }
             }
        });
        
        function displayError(message) {
            console.error(message);
            alert(`Error: ${message}`);
        }

        // --- Initialization ---
        function renderAll() {
            renderProjectList();
            updateToggleButton();
            renderStatusText();
        }
        
        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
             loadSavedProjectsFromStorage();
             loadProjectsFromAPI();
        });
    </script>
</body>
</html>
